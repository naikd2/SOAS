(function(c){c.widget("ui.writetable",{options:{tableName:"writeable-data",singleCellEditMode:!1,enableAddRow:!0,autoAddRow:!0,editModeClass:"writeable-editmode",columnDefaults:{name:"",type:"text",editable:!0,required:!1,cssClass:"",placeholder:""}},columns:[],_create:function(){c.metadata&&(this.options=c.extend(!0,{},this.options,this.element.metadata()));var a=this.options,b=this.element.first("tbody");this._initColumns();b.on("click","tr",c.proxy(this._rowSelected,this));a.enableAddRow&&a.autoAddRow&&
this.addRow(!0);this._trigger("create",null,this)},_init:function(){this._trigger("init",null,this)},_initColumns:function(){var a=this;a.columns=[];a.element.find("thead th").each(function(b){b=c.extend({},a.options.columnDefaults,c.metadata?c(this).metadata():a.options.columns[b]);a.columns.push({name:b.name,type:b.type,editable:b.editable,required:b.required,cssClass:b.cssClass,placeholder:b.placeholder})})},destroy:function(){this.element.first("tbody").off("click","tr",c.proxy(this._rowSelected,
this));c.Widget.prototype.destroy.call(this);this._trigger("destroyed",null,this)},_setOption:function(a,b){switch(a){case "singleCellEditMode":case "enableAddRow":case "autoAddRow":this.options[a]=b}c.Widget.prototype._setOption.apply(this,arguments)},_rowSelected:function(a){var b=c(a.target).closest("tr");this._removeBlankRows(b);this._makeRowEditable(b);var d=c(a.target).closest("td").children("input").first();d.focus();d.select();this._trigger("rowSelected",a,b);return this},_removeBlankRows:function(a){var b=
this,d=this.element.find("tbody tr");a&&(d=d.not(a));d.each(function(){b._rowIsBlank(c(this))&&c(this).remove()})},_makeRowEditable:function(a){var b=this;a.hasClass(b.options.editModeClass)||(a.siblings("."+b.options.editModeClass).each(function(){c(this).removeClass(b.options.editModeClass);c(this).children("td").has("input").each(function(){var a=c(this).children("input").first();a.hide();c(this).children("span").show().text(a.val())})}),a.addClass(b.options.editModeClass),a.children("td").each(function(d){if(b.columns[d].editable){var e=
c(this);b._initEditableCell(e,d,a.attr("rowId"))}}))},_initEditableCell:function(a,b,d){var e=c(a).children("input").first();if(0==e.size()){e=this.options.tableName+"["+d+"]."+this.columns[b].name;d=this.columns[b].cssClass;b=this.columns[b].placeholder;var f=a.text(),e=c("<input id='"+e+"' name='"+e+"' type='text'/>");d&&e.attr("class",d);b&&e.attr("placeholder",b);f&&e.val(f.trim());d=c("<span></span>");d.text(a.text());a.empty();a.append(d);a.append(e)}e.val(c("span",a).text());e.show();c("span",
a).hide()},addRow:function(a){if(this._allowNewRow()){var b=this._getNextRowId(),d=c("<tr></tr>");d.attr("rowId",b);this.element.find("tbody").first().append(d);for(b=0;b<this.columns.length;b++){var e=c("<td></td>");d.append(e)}this._makeRowEditable(d);a||d.children("td").slice(0,1).find("input").first().focus();this._trigger("rowAdded",null,d)}else a=this.element.find("tr").last(),this._makeRowEditable(a);return this},removeRow:function(a,b){this._trigger("rowRemoved",a,b);a.isPropagationStopped()||
b.remove()},_allowNewRow:function(){if(!this.options.enableAddRow)return!1;var a=this.element.find("tbody tr");return 0<a.length?(a=a.last(),1!=this._rowIsBlank(a)):!0},_rowIsBlank:function(a){var b=!0;a.children("td").each(function(a){a=c(this);if(""!=a.text().trim()||a.children("input").first().val())b=!1});return b},getNumColumns:function(){return this.columns.length},_getNextRowId:function(){var a=-1;this.element.find("tbody tr[rowId]").each(function(){a=Math.max(a,parseInt(c(this).attr("rowId")))});
return++a}})})(jQuery);